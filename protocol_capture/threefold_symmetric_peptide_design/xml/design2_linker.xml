<ROSETTASCRIPTS>
	<SCOREFXNS>
		<ScoreFunction name="tala" weights="xml/talaris2014_modified.wts" >
		</ScoreFunction>
		<ScoreFunction name="tala_symm" weights="xml/talaris2014_modified.wts" symmetric="true" >
		</ScoreFunction>
		<ScoreFunction name="tala_symm_soft" weights="xml/talaris2014_modified.wts" symmetric="true" >
			<Reweight scoretype="fa_rep" weight="0.1" />
		</ScoreFunction>
		<ScoreFunction name="tala_symm_cst" weights="xml/talaris2014_modified.wts" symmetric="true" >
			<Reweight scoretype="coordinate_constraint" weight="0.333" />
			<Reweight scoretype="atom_pair_constraint" weight="0.333" />
			<Reweight scoretype="angle_constraint" weight="0.333" />
			<Reweight scoretype="dihedral_constraint" weight="0.333" />
		</ScoreFunction>
		<ScoreFunction name="symm_cst_only" weights="empty.wts" symmetric="true" >
			<Reweight scoretype="coordinate_constraint" weight="0.333" />
			<Reweight scoretype="atom_pair_constraint" weight="0.333" />
			<Reweight scoretype="angle_constraint" weight="0.333" />
			<Reweight scoretype="dihedral_constraint" weight="0.333" />
		</ScoreFunction>
	</SCOREFXNS>
	<RESIDUE_SELECTORS>
		<Layer name="select_core" select_core="true" select_boundary="false" select_surface="false" use_sidechain_neighbors="false" ball_radius="2.0" core_cutoff="30" surface_cutoff="50" />
		<Layer name="select_boundary" select_core="false" select_boundary="true" select_surface="false" use_sidechain_neighbors="false" ball_radius="2.0" core_cutoff="30" surface_cutoff="50" />
		<Layer name="select_surface" select_core="false" select_boundary="false" select_surface="true" use_sidechain_neighbors="false" ball_radius="2.0" core_cutoff="30" surface_cutoff="50" />
	</RESIDUE_SELECTORS>
	<TASKOPERATIONS>
	
		<RestrictToRepacking name="nodesign" />
		
		<RestrictResiduesToRepacking name="only_repack_linker" residues="21,42,63" />
		
		<ReadResfile name="core_resfile" selector="select_core" filename="xml/core.resfile" />
		<ReadResfile name="boundary_resfile" selector="select_boundary" filename="xml/boundary.resfile" />
		<ReadResfile name="surface_resfile" selector="select_surface" filename="xml/surface.resfile" />

	</TASKOPERATIONS>
	<FILTERS>
		<ScoreType name="initial_clash_check" scorefxn="tala_symm" score_type="fa_rep" threshold="100" />
		<ScoreType name="bad_linker_filter" scorefxn="symm_cst_only" score_type="total_score" threshold="40" />
		<FragmentLookupFilter name="faulty_fragments_tolerant" lookup_name="source_fragments_4_mer_tolerant" store_path="backbone_profiler_database_06032014"	lookup_mode="first" threshold="0" confidence="1" />
		<FragmentLookupFilter name="faulty_fragments" lookup_name="source_fragments_4_mer" store_path="backbone_profiler_database_06032014" lookup_mode="first" threshold="0" confidence="1" />

	</FILTERS>
	<MOVERS>

		<BundleGridSampler name="bgs1" helix_length="20" scorefxn="tala" set_bondlengths="true" set_bondangles="true" set_dihedrals="true"
			nstruct_mode="true" nstruct_repeats="1" use_degrees="true" max_samples="311600"
			r0_min="4.5" r0_max="9" r0_samples="19" omega0_min="-10" omega0_max="10" omega0_samples="41" delta_omega0="0" delta_omega1_min="0" delta_omega1_max="337.5" delta_omega1_samples="16"
			delta_t="0" z1_offset_min="-3" z1_offset_max="3" z1_offset_samples="25" >
			<Helix />
		</BundleGridSampler>
		
		<MutateResidue name="makecys" target="11" new_res="CYX" />
		
		<PeptideStubMover name="add_linker" reset="false">
			<Append resname="TBMBSYMM" anchor_rsd="11" anchor_atom="SG" connecting_atom="CM1" />
		</PeptideStubMover>
		
		<DeclareBond name="add_termini" res1="1" res2="2" atom1="C" atom2="N" add_termini="true" />

		<DeclareBond name="linkerbond1" res1="21" res2="42" atom1="C2" atom2="C1" add_termini="true" />
		<DeclareBond name="linkerbond2" res1="42" res2="63" atom1="C2" atom2="C1" add_termini="true" />
		<DeclareBond name="linkerbond3" res1="63" res2="21" atom1="C2" atom2="C1" add_termini="true" />

		
		<AtomTree name="foldtree1" fold_tree_file="xml/foldtree1.txt" />
		
		<SetupForSymmetry name="setup_symm" definition="symmetry/c3_y.symm" />
		
		<FastRelax name="frelax_linker" task_operations="nodesign" min_type="lbfgs_armijo_nonmonotone" scorefxn="tala_symm_cst" repeats="1" >
			<MoveMap name="frelax_linker_mm" >
				<Jump number="1" setting="1" />
				<Jump number="2" setting="1" />
				<Jump number="3" setting="1" />
				<Jump number="4" setting="0" />
				<Jump number="5" setting="0" />
				<Jump number="6" setting="0" />
				<Jump number="7" setting="0" />
				<Jump number="8" setting="0" />
				<Jump number="9" setting="0" />
				<Span begin="1" end="999" chi="1" bb="0" />
			</MoveMap>
		</FastRelax>
		
		<DeclareBond name="linkends1" res1="20" res2="22" atom1="C" atom2="N" add_termini="false" />
		<DeclareBond name="linkends2" res1="41" res2="43" atom1="C" atom2="N" add_termini="false" />
		<DeclareBond name="linkends3" res1="62" res2="1" atom1="C" atom2="N" add_termini="false" />
		
		<SymPackRotamersMover name="quickpack" scorefxn="tala_symm_soft" task_operations="core_resfile,boundary_resfile,surface_resfile,only_repack_linker" />
		
		<SymMinMover name="quickmin" scorefxn="tala_symm_cst" bb="false" chi="true" jump="0" type="lbfgs_armijo_nonmonotone" tolerance="0.001" >
			<MoveMap name="quickmin_mm" >
				<Span begin="1" end="999" bb="0" chi="1" />
				<Jump number="1" setting="1" />
				<Jump number="2" setting="1" />
				<Jump number="3" setting="1" />
				<Jump number="4" setting="0" />
				<Jump number="5" setting="0" />
				<Jump number="6" setting="0" />
				<Jump number="7" setting="0" />
				<Jump number="8" setting="0" />
				<Jump number="9" setting="0" />
			</MoveMap>
		</SymMinMover>
		
		<ParsedProtocol name="quickpackmin" >
			<Add filter="initial_clash_check" />
			<Add filter="faulty_fragments_tolerant" />
			<Add mover="quickpack" />
			<Add mover="quickmin" />
		</ParsedProtocol>
		
		<GeneralizedKIC name="genkic1" closure_attempts="100" selector="lowest_energy_selector" selector_scorefunction="tala_symm" pre_selection_mover="quickpackmin" >
			<AddResidue res_index="17" />
			<AddResidue res_index="18" />
			<AddResidue res_index="19" />
			<AddResidue res_index="20" />
			<AddResidue res_index="22" />
			<AddResidue res_index="23" />
			<SetPivots res1="17" atom1="CA" res2="19" atom2="CA" res3="23" atom3="CA" />
			<CloseBond res1="20" res2="22" atom1="C" atom2="N" bondlength="1.32" angle1="114" angle2="123" torsion="180" />
			<AddPerturber effect="randomize_backbone_by_bins" bin_params_file="ABBA" >
				<AddResidue index="17" />
				<AddResidue index="18" />
				<AddResidue index="19" />
				<AddResidue index="20" />
				<AddResidue index="22" />
				<AddResidue index="23" />
			</AddPerturber>
			<AddFilter type="loop_bump_check" />	
		</GeneralizedKIC>
		
		<FastDesign name="fdes1" task_operations="core_resfile,boundary_resfile,surface_resfile,only_repack_linker" disable_design="false" min_type="lbfgs_armijo_nonmonotone" scorefxn="tala_symm_cst" repeats="1" >
			<MoveMap name="fdes1_mm" >
				<Jump number="1" setting="1" />
				<Jump number="2" setting="1" />
				<Jump number="3" setting="1" />
				<Jump number="4" setting="0" />
				<Jump number="5" setting="0" />
				<Jump number="6" setting="0" />
				<Jump number="7" setting="0" />
				<Jump number="8" setting="0" />
				<Jump number="9" setting="0" />
				<Span begin="1" end="999" chi="1" bb="0" />
			</MoveMap>
		</FastDesign>
		
		<ConstraintSetMover name="constrain_pepbonds" add_constraints="true" cst_file="constraints/pepbonds.cst" />
		<ConstraintSetMover name="constrain_linker" add_constraints="true" cst_file="constraints/linker.cst" />

		<FastDesign name="fdes2" task_operations="core_resfile,boundary_resfile,surface_resfile,only_repack_linker" disable_design="false" min_type="lbfgs_armijo_nonmonotone" scorefxn="tala_symm_cst" ramp_down_constraints="false" repeats="3" >
			<MoveMap name="fdes1_mm">
				<Jump number="1" setting="1" />
				<Jump number="2" setting="1" />
				<Jump number="3" setting="1" />
				<Jump number="4" setting="1" />
				<Jump number="5" setting="1" />
				<Jump number="6" setting="1" />
				<Jump number="7" setting="1" />
				<Jump number="8" setting="1" />
				<Jump number="9" setting="1" />
				<Span begin="1" end="999" chi="1" bb="1" />
			</MoveMap>
		</FastDesign>
	
	</MOVERS>
	<APPLY_TO_POSE>
	</APPLY_TO_POSE>
	<PROTOCOLS>
		<Add mover="bgs1" />
		<Add mover="makecys" />
		<Add mover="add_linker" />
		<Add mover="add_termini" />
		<Add mover="foldtree1" />
		<Add mover="setup_symm" />
		<Add mover="linkerbond1" />
		<Add mover="linkerbond2" />
		<Add mover="linkerbond3" />
		<Add mover="constrain_linker" />
		<Add mover="frelax_linker" />
		<Add filter="bad_linker_filter" />
		<Add mover="linkends1" />
		<Add mover="linkends2" />
		<Add mover="linkends3" />
		<Add mover="genkic1" />
		<Add mover="fdes1" />
		<Add mover="constrain_pepbonds" />
		<Add mover="fdes2" />
		<Add mover="linkends1" />
		<Add mover="linkends2" />
		<Add mover="linkends3" />
		<Add filter="faulty_fragments" />
	</PROTOCOLS>
	<OUTPUT scorefxn="tala_symm" />
</ROSETTASCRIPTS>
