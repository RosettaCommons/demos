Controlling Input and Output in Rosetta
=======================================
Tutorial by Shourya S. Roy Burman (ssrb@jhu.edu)  
Created 21 June 2016

[[_TOC_]]

Summary
-------
There are multiple ways to control how Rosetta protocols read the nput and produce output. By the end of this tutorial, you should understand:

* What input formats are supported in Rosetta
* How to deal with odd residues that often cause Rosetta to crash
* How best to prepare an input structure
* How to ask Rosetta to compare it with a known structure
* How to change the input and output paths in Rosetta
* How to ensure that you get a consistent running trajectory despite being a Monte Carlo protocol
* How to visualize the changes to the structure in PyMOL
* How to overwrite existing output

>This chapter will cover many executables, whose function will not be explained in much detail. Please refer the the corresponding chapter in the tutorials for a proper explanation of what that particular program does.

Navigating to the Demos
-----------------------
The demos are available at `<path_to_Rosetta_directory>/demos/tutorials/input_and_output`. All demo commands listed in this tutorial should be executed when in this directory. All the demos here use the `linuxgccrelease` binary. You may be required to change it to whatever is appropriate given your operating system and compiler.

Controlling Input
-----------------
###Common Stucture Input Files
You can supply Rosetta with a variety of input files which hold the coordinates of your biomolecular structure.
####PDB File
The most common input file format is the PDB format. A detailed description of the PDB format can be found on the [WorldWide Protein Data Bank website](http://www.wwpdb.org/documentation/file-format-content/format33/v3.3.html). Primarily the lines which concern Rosetta start with `ATOM`, `HETATM` and `TER`.

```html
...
ATOM   1477 3HD2 LEU A  94      10.910  -5.038   7.227  1.00  0.00           H  
TER                                                                             
HETATM 1479  O   HOH A 107      10.027  -4.206  14.093  1.00  0.00           O 
...
```
In the example above, Rosetta recognizes that the `ATOM` record represents one of the H<sub>δ</sub> atoms of Leucine-94 in the A chain with coordinates (10.910, -5.038, 7.227), which has an occupancy of 1 and a temperature factor of 0. Rosetta ignores the atom numbering (`1477`) in the second column and the element symbol in the last column (`H`). The `TER` record indicates a chain break. Similarly the `HETATM` record represents the oxygen atom of a water molecule associated with the A chain with coordinates (10.027, -4.206, 14.093) an occupancy 1 and a temperature factor of 0. Rosetta ignores the atom numbering and the element symbol in this record too. Rosetta stores the temperature factors, but **assumes all non-zero occupancies to be 1.**

>Rosetta only loads in the first conformation if a residue has multiple conformations.

To pass in a single PDB use the `in:file:s` option. For example, the following can be used to [calculate the energy](https://www.rosettacommons.org/demos/latest/tutorials/scoring/README) of a refined PDB 1QYS. The input PDB is present in the `input_files` folder.

    $> <path_to_Rosetta_directory>/main/source/bin/score_jd2.linuxgccrelease -in:file:s input_files/1qys.pdb
    
Running this should produce a file called `score.sc` in your current working directory with the energy scores of 1QYS. *To proceed on to the next step, remove `score.sc` by typing `rm score.sc`. Else, all energy scores of the structures scored here onwards will be appended to this file.*

####List of PDBs
Suppose you want to pass multiple input structures to an executable, use the option `in:file:l`. Say, you want to score two PDBs - 1QYS and 1UBQ. We can pass a list of PDBs called `pdblist`, which contains one path to PDB per line (space separated PDBs work, but they cannot be comma or semi-colon separated) like this:

    input_files/1qys.pdb
    input_files/1ubq.pdb
    
To run, execute:

    $> <path_to_Rosetta_directory>/main/source/bin/score_jd2.linuxgccrelease -in:file:l input_files/pdblist
    
    
Running this should produce a file called `score.sc` in your current working directory. *To proceed on to the next step, remove `score.sc` by typing `rm score.sc`. Else, all energy scores of the structures scored here onwards will be appended to this file.*

####Silent File
A silent file is a Rosetta-specific compact format file which stores information from multiple structures. It is especially useful when running simulations with a large number of output structures, where many filesystems will have problems running batch operations. Silent files can be generated by many Rosetta simulations. An example of a _binary silent struct file_ can be found at `<path_to_Rosetta_directory>/demos/tutorials/input_and_output/input_files/1qys.o `.

The first few lines represent the information about the sequence, energy and relative rotation/translation of the chains. The main body, however, is not human readable.

There is another silent file format called _protein silent struct file_ that is human readable, but Rosetta sometimes is unable to output in this format and hence, it is not discussed in this tutorial. Details about this can be found [here](https://www.rosettacommons.org/docs/latest/rosetta_basics/file_types/silent-file).

To give Rosetta a silent file as an input, use the `in:file:silent` option while running your command like this:

    $> <path_to_Rosetta_directory>/main/source/bin/score_jd2.linuxgccrelease -in:file:silent input_files/1qys.o
    
You should again produce a file called `score.sc` in your current working directory with the energy scores of 1QYS. _To proceed on to the next step, remove `score.sc` by typing `rm score.sc`. Else, all energy scores of the structures scored here onwards will be appended to this file._

_The option `in:file:silent` can also be used to pass a list of silent files._

####mmCIF File
Rosetta also supports a more recent file format called mmCIF whose details can be found [here](http://mmcif.wwpdb.org/docs/tutorials/content/atomic-description.html). You can use the `in:file:s` option to input mmCIF files as well, and Rosetta automatically wether the file is format is mmCIF or PDB.

Try running:

    $> <path_to_Rosetta_directory>/main/source/bin/score_jd2.linuxgccrelease -in:file:s input_files/1qys.cif -ignore_unrecognized_res -ignore_zero_occupancy false
    
>**TO BE FINISHED WHEN MMCIF JOB INPUTTER IS MERGED INTO MASTER**


###Dealing with Odd Residues/Waters
Most Rosetta protocols expect the structure they are working on to have a certain set of properties, eg. all heavy atoms should be present, all residue names should be recognizable etc. Sometimes Rosetta can guess which atoms to add. In this example, we will score the PDB 1QYS taken directly from the Protein Data Bank:

    $> <path_to_Rosetta_directory>/main/source/bin/score_jd2.linuxgccrelease -in:file:s input_files/from_rcsb/1qys.pdb
    
In the log, you will see the following lines:
```html
...
core.io.pose_from_sfr.PoseFromSFRBuilder: Reading MSE as MET!
...
core.pack.pack_missing_sidechains: packing residue number 13 because of missing atom number 6 atom name  CG
...
```
The first line indicates that it converts the residue _MSE_, i.e. selenomethionine to _MET_, i.e. regular methionine. The second line tells you that Rosetta found that the C<sub>γ</sub> atom was missing in residue number 13, and built the sidechain for residue number 13.

####Unrecognized Residues
A PDB downloaded directly from the Protein Data Bank may or may not work with Rosetta in general. Here's an example where we try to score the PDB 3TDM. When in the right demo directory, run:

    $> <path_to_Rosetta_directory>/main/source/bin/score_jd2.linuxgccrelease -in:file:s input_files/from_rcsb/3tdm.pdb
   
The application will exit with the following error:

    ERROR: Unrecognized residue: PO4
    
This PDB contains a phosphate ion that Rosetta is unable to process without additional options. To score this PDB, we will add an option `-ignore_unrecognized_res`, which simply ignores the phosphates in the PDB.

    $> <path_to_Rosetta_directory>/main/source/bin/score_jd2.linuxgccrelease -in:file:s input_files/from_rcsb/3tdm.pdb -ignore_unrecognized_res

Now the PDB will be scored and the score will be displayed in a file `score.sc`.

>`ignore_unrecognized_res` option also ignores the water molecules in the structure. This may change the energy scores of your structure.

####Waters

>**Skipping this section till the default status of HOH is clarified. Presently, they are loaded in and scored, but -ignore_unrcognized_res takes them out and changes score.**

####Zero Occupancy
Occupancy denotes the fraction of cases where a particular conformation is observed. While most atoms will have an occupancy of 1, if a residue was observed in multiple conformations, the occupancy will be lower than 1. An occupancy of 0 indicates that the atom was never observed in the crystal (but is estimated to be present at that location). Rosetta ignores these atom records. If it is a non-backbone heavy atom, it might build the sidechain for you. If it is a backbone heavy atom like N or CA, it will delete the entire residue.

We have modified the occupancies of 1QYS to get the file `<path_to_Rosetta_directory>/demos/tutorials/input_and_output/input_files/1qys_zero_occ.pdb`. It has zero occupancies for the first few atoms
```html
ATOM      1  N   ASP A   3      -4.524  18.589  17.199  0.00  0.00           N  
ATOM      2  CA  ASP A   3      -3.055  18.336  17.160  0.00  0.00           C
...
```
On running,

    $>  <path_to_Rosetta_directory>/main/source/bin/score_jd2.linuxgccrelease -in:file:s input_files/1qys_zero_occ.pdb
    
You get the following warnings in your log file:

```html
...
core.io.pose_from_sfr.PoseFromSFRBuilder: PDB reader is ignoring atom  N   in residue 3 A.  Pass flag -ignore_zero_occupancy false to change this behavior
core.io.pose_from_sfr.PoseFromSFRBuilder: PDB reader is ignoring atom  CA  in residue 3 A.  Pass flag -ignore_zero_occupancy false to change this behavior
...
core.io.pose_from_sfr.PoseFromSFRBuilder: [ WARNING ] skipping pdb residue b/c it's missing too many mainchain atoms:    3 A ASP ASP:NtermProteinFull

...
```

Also note that the score in `score.sc` is higher from the previous runs. This is because it deletes residue 3 and hence loses the ~-3 REU score of the residue. _To proceed on to the next step, remove `score.sc` by typing `rm score.sc`. Else, all energy scores of the structures scored here onwards will be appended to this file._


There are several Rosetta applications, which require constant sequence length between things they are comapring, like the _docking_protocol_, which may even crash without an informative error message if zero occupancy atoms are present.

To fix this, we need to use an option class `-ignore_zero_occupancy` that is set to true by default. Adding the option `-ignore_zero_occupancy false` will force Rosetta to read in atoms with occupancy 0 as follows:

    $>  <path_to_Rosetta_directory>/main/source/bin/score_jd2.linuxgccrelease -in:file:s input_files/1qys_zero_occ.pdb -ignore_zero_occupancy false
    
The score file, `score.sc` produced by this run should match the one with the first example in this chapter.

###Preparing a Structure by Refinement
The recommended way to prepare input structures for most Rosetta protocols is to run the refinement protocol, _relax_ on your structure prior to running the Rosetta application you want. A detailed tutorial on _relax_ can be found [here](https://www.rosettacommons.org/demos/latest/tutorials/Tutorial_4_Relax/Tutorial_4_Relax.md).

While we want to relieve clashes in the input structure and ensure meeting all of Rosetta's specifications, we do not want our backbone to move much. A set of general options have been specified in `<path_to_Rosetta_directory>/demos/tutorials/input_and_output/flag_input_relax`. 

```html
-nstruct 2

-relax:constrain_relax_to_start_coords
-relax:ramp_constraints false

-ex1
-ex2

-use_input_sc
-flip_HNQ
-no_optH false
```
Setting a higher `nstruct`, say `nstruct 10`, will increase the number of refinement runs and may produce better results, but may also consume a lot of time.

We will use this flags file to refine the PDB 1QYS take directly from the Protein Data Bank. This may take a few minutes to run:

    $>  <path_to_Rosetta_directory>/main/source/bin/relax.linuxgccrelease -in:file:s input_files/from_rcsb/1qys.pdb @flag_input_relax
    
This will produce three files: `1qys_0001.pdb`, `1qys_0002.pdb` and `score.sc`. Use the PDB with the lower `total_score` in the score file as the input PDB for your protocol.

>These options can also be supplemented by `ignore_unrecognized_res` and `ignore_zero_occupany false` if required.

>Ensure that all residues you want to model are present in the refined PDB. Using a flag like `ignore_unrecognized_res` may remove ligands and waters you want to consider.

###Input Search Paths
###Informing a Protocol about the Input Representation - Centroid or Full Atom
###Input a Known Structure For Comparison
###Other Specific Options



Controlling Output
------------------
###Common Stucture Input Files
####Gzipped Files

###Adding Prefixes and Suffixes to the Output PDBs
###Setting Output Paths
####Output Structure
####Score File
###Forcing and Supressing Output of Structures
####Only Output a Score File
###Adjusting Detail Level in Logs
###Getting the Same Output despite Monte Carlo
###Near-realtime Visualization in PyMOL
###Overwriting Previously Generated Output

